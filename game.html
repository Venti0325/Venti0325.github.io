<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>èº²é¿é™¨çŸ³ | å°ç½‘é¡µæ¸¸æˆ</title>
  <style>
    :root { color-scheme: light; }
    body{
      margin:0; height:100vh; display:grid; place-items:center;
      background:#0b1020; color:#e9eefc;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      overflow:hidden;
    }
    .wrap{ width:min(920px, 94vw); }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:10px 0 12px;
    }
    .title{ font-weight:800; letter-spacing:.2px; }
    .hint{ opacity:.75; font-size:14px; }
    canvas{
      width:100%; aspect-ratio: 16/9;
      background: radial-gradient(1200px 600px at 30% 10%, #18224a 0%, #0b1020 55%, #070a14 100%);
      border-radius:16px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      touch-action:none; /* å…è®¸æˆ‘ä»¬æ¥ç®¡è§¦æ§æ‹–åŠ¨ */
    }
    .bar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:0; border-radius:12px; padding:10px 12px;
      background:#e9eefc; color:#0b1020; font-weight:700; cursor:pointer;
    }
    button:hover{ filter:brightness(.95); }
    a{ color:#9cc0ff; text-decoration:none; font-weight:700; }
    a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">â˜„ï¸ èº²é¿é™¨çŸ³</div>
      <div class="hint">é”®ç›˜ï¼šâ† â†’ / A D ï½œæ‰‹æœºï¼šæ‹–åŠ¨é£èˆ¹ ï½œç©ºæ ¼ï¼šæš‚åœ</div>
    </div>

    <canvas id="c" width="960" height="540"></canvas>

    <div class="bar">
      <button id="restart">é‡æ–°å¼€å§‹</button>
      <button id="pause">æš‚åœ/ç»§ç»­</button>
      <a href="index.html">â† å›åˆ°ä¸»é¡µ</a>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  // ---------- æ¸¸æˆçŠ¶æ€ ----------
  let running = true;
  let gameOver = false;
  let score = 0;
  let best = Number(localStorage.getItem('best_score') || 0);

  // ç©å®¶ï¼ˆé£èˆ¹ï¼‰
  const player = {
    x: canvas.width / 2,
    y: canvas.height * 0.84,
    r: 16,
    vx: 0,
    speed: 520, // åƒç´ /ç§’
  };

  // é™¨çŸ³åˆ—è¡¨
  const rocks = [];
  let spawnTimer = 0;
  let spawnInterval = 0.75; // åˆå§‹åˆ·æ€ªé—´éš”ï¼ˆç§’ï¼‰ï¼Œä¼šé€æ¸å˜å¿«

  // è¾“å…¥
  const keys = { left:false, right:false };

  // è®©ç”»é¢åœ¨ä¸åŒåˆ†è¾¨ç‡ä¹Ÿâ€œæ¸…æ™°â€
  function fitDPR(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const rect = canvas.getBoundingClientRect();
    const w = Math.round(rect.width * dpr);
    const h = Math.round(rect.height * dpr);
    if (canvas.width !== w || canvas.height !== h) {
      canvas.width = w;
      canvas.height = h;
      // é‡æ–°å®šä½ç©å®¶åˆ°åˆç†ä½ç½®
      player.y = canvas.height * 0.84;
      player.x = Math.min(player.x, canvas.width - player.r - 10);
    }
  }
  // åˆæ¬¡é€‚é…
  requestAnimationFrame(() => { fitDPR(); });

  // ---------- å·¥å…· ----------
  const rand = (a,b)=> a + Math.random()*(b-a);
  const clamp = (v,a,b)=> Math.max(a, Math.min(b, v));
  function dist2(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy; }

  // ---------- ç”Ÿæˆé™¨çŸ³ ----------
  function spawnRock() {
    const r = rand(10, 28);
    const x = rand(r + 10, canvas.width - r - 10);
    const y = -r - 10;
    const vy = rand(160, 320) + score*0.8; // åˆ†æ•°è¶Šé«˜è¶Šå¿«
    const vx = rand(-60, 60);
    rocks.push({ x,y,r,vx,vy,spin: rand(-2,2), a: rand(0, Math.PI*2) });
  }

  // ---------- æ¸²æŸ“ ----------
  function drawBG(){
    // æ˜Ÿç©ºç‚¹ç‚¹
    ctx.save();
    ctx.globalAlpha = 0.25;
    for(let i=0;i<60;i++){
      const x = (i*197) % canvas.width;
      const y = (i*389) % canvas.height;
      const s = (i%3)+1;
      ctx.fillStyle = '#cfe0ff';
      ctx.fillRect(x, y, s, s);
    }
    ctx.restore();
  }

  function drawPlayer(){
    // é£èˆ¹ï¼šä¸€ä¸ªå°ä¸‰è§’+åœ†å½¢èˆ±
    ctx.save();
    ctx.translate(player.x, player.y);

    // æ¨è¿›å°¾ç„°ï¼ˆå°åŠ¨ç”»ï¼‰
    const flame = 8 + Math.sin(perfNow/80)*3;
    ctx.fillStyle = '#ffcc66';
    ctx.beginPath();
    ctx.moveTo(-8, 12);
    ctx.lineTo(0, 12+flame);
    ctx.lineTo(8, 12);
    ctx.closePath();
    ctx.fill();

    // èˆ±ä½“
    ctx.fillStyle = '#e9eefc';
    ctx.beginPath();
    ctx.arc(0, 0, player.r, 0, Math.PI*2);
    ctx.fill();

    // å‰é¼»é”¥
    ctx.fillStyle = '#9cc0ff';
    ctx.beginPath();
    ctx.moveTo(0, -player.r-12);
    ctx.lineTo(-12, 4);
    ctx.lineTo(12, 4);
    ctx.closePath();
    ctx.fill();

    // èˆ·çª—
    ctx.fillStyle = '#0b1020';
    ctx.beginPath();
    ctx.arc(0, -3, 5, 0, Math.PI*2);
    ctx.fill();

    ctx.restore();
  }

  function drawRock(rock){
    ctx.save();
    ctx.translate(rock.x, rock.y);
    ctx.rotate(rock.a);

    ctx.fillStyle = '#8b93a9';
    ctx.beginPath();
    // ç”»ä¸€ä¸ªä¸è§„åˆ™å¤šè¾¹å½¢ï¼Œåƒé™¨çŸ³
    const n = 8;
    for(let i=0;i<n;i++){
      const ang = (i/n)*Math.PI*2;
      const rr = rock.r * rand(0.75, 1.15);
      const px = Math.cos(ang)*rr;
      const py = Math.sin(ang)*rr;
      if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    }
    ctx.closePath();
    ctx.fill();

    ctx.globalAlpha = 0.25;
    ctx.strokeStyle = '#e9eefc';
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.restore();
  }

  function drawHUD(){
    ctx.save();
    ctx.fillStyle = 'rgba(233,238,252,.92)';
    ctx.font = `${Math.round(canvas.height*0.045)}px Arial`;
    ctx.fillText(`Score: ${Math.floor(score)}`, 16, 42);
    ctx.fillText(`Best: ${best}`, 16, 82);

    if(!running && !gameOver){
      ctx.textAlign = 'center';
      ctx.font = `${Math.round(canvas.height*0.06)}px Arial`;
      ctx.fillText('â¸ å·²æš‚åœï¼ˆæŒ‰ç©ºæ ¼ç»§ç»­ï¼‰', canvas.width/2, canvas.height/2);
    }

    if(gameOver){
      ctx.textAlign = 'center';
      ctx.font = `${Math.round(canvas.height*0.075)}px Arial`;
      ctx.fillText('ğŸ’¥ æ¸¸æˆç»“æŸ', canvas.width/2, canvas.height*0.44);
      ctx.font = `${Math.round(canvas.height*0.05)}px Arial`;
      ctx.fillText(`æœ€ç»ˆåˆ†æ•°ï¼š${Math.floor(score)}`, canvas.width/2, canvas.height*0.52);
      ctx.font = `${Math.round(canvas.height*0.04)}px Arial`;
      ctx.fillText('ç‚¹â€œé‡æ–°å¼€å§‹â€å†æ¥ä¸€å±€', canvas.width/2, canvas.height*0.60);
    }
    ctx.restore();
  }

  // ---------- æ›´æ–°é€»è¾‘ ----------
  let last = performance.now();
  let perfNow = last;

  function update(dt){
    // åˆ†æ•°æŒ‰æ—¶é—´å¢é•¿
    score += dt * 10;

    // éš¾åº¦ï¼šåˆ·æ€ªè¶Šæ¥è¶Šå¿«ï¼ˆä¸‹é™ 0.25sï¼‰
    spawnInterval = Math.max(0.25, 0.75 - score/400);

    // ç©å®¶é€Ÿåº¦
    player.vx = 0;
    if(keys.left) player.vx -= player.speed;
    if(keys.right) player.vx += player.speed;
    player.x += player.vx * dt;
    player.x = clamp(player.x, player.r + 10, canvas.width - player.r - 10);

    // ç”Ÿæˆé™¨çŸ³
    spawnTimer += dt;
    while(spawnTimer >= spawnInterval){
      spawnTimer -= spawnInterval;
      spawnRock();
    }

    // æ›´æ–°é™¨çŸ³
    for(const rock of rocks){
      rock.x += rock.vx * dt;
      rock.y += rock.vy * dt;
      rock.a += rock.spin * dt;
    }

    // æ¸…ç†å‡ºç•Œé™¨çŸ³
    for(let i=rocks.length-1;i>=0;i--){
      if(rocks[i].y - rocks[i].r > canvas.height + 40) rocks.splice(i,1);
    }

    // ç¢°æ’æ£€æµ‹ï¼šåœ†-åœ†ç¢°æ’
    const pr2 = player.r * player.r;
    for(const rock of rocks){
      const rr = rock.r + player.r * 0.85;
      if(dist2(player.x, player.y, rock.x, rock.y) <= rr*rr){
        gameOver = true;
        running = false;
        best = Math.max(best, Math.floor(score));
        localStorage.setItem('best_score', best);
        break;
      }
    }
  }

  function render(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBG();
    for(const rock of rocks) drawRock(rock);
    drawPlayer();
    drawHUD();
  }

  function loop(now){
    perfNow = now;
    const dt = Math.min(0.033, (now - last) / 1000); // é˜²æ­¢åˆ‡åå° dt çˆ†ç‚¸
    last = now;

    fitDPR();

    if(running && !gameOver) update(dt);
    render();

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ---------- æ§åˆ¶ ----------
  function togglePause(){
    if(gameOver) return;
    running = !running;
  }
  function restart(){
    rocks.length = 0;
    spawnTimer = 0;
    score = 0;
    gameOver = false;
    running = true;
    player.x = canvas.width/2;
    player.y = canvas.height*0.84;
  }

  // é”®ç›˜
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') keys.left = true;
    if(e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') keys.right = true;
    if(e.key === ' ') { e.preventDefault(); togglePause(); }
  });
  window.addEventListener('keyup', (e)=>{
    if(e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') keys.left = false;
    if(e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') keys.right = false;
  });

  // è§¦æ§/é¼ æ ‡æ‹–åŠ¨ï¼šè®©é£èˆ¹è·Ÿç€æ‰‹æŒ‡èµ°ï¼ˆæ›´ç›´è§‰ï¼‰
  let dragging = false;
  function pointerToX(evt){
    const rect = canvas.getBoundingClientRect();
    const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
    const ratio = canvas.width / rect.width;
    return (clientX - rect.left) * ratio;
  }
  canvas.addEventListener('pointerdown', (e)=>{ dragging = true; player.x = pointerToX(e); });
  canvas.addEventListener('pointermove', (e)=>{ if(dragging) player.x = pointerToX(e); });
  window.addEventListener('pointerup', ()=> dragging = false);

  // æŒ‰é’®
  document.getElementById('pause').addEventListener('click', togglePause);
  document.getElementById('restart').addEventListener('click', restart);

})();
</script>
</body>
</html>
